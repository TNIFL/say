{% extends "base.html" %}

{% block title %}Lexinoa Â· ê²°ì œ ì²´í¬ì•„ì›ƒ{% endblock %}

{% block head_extra %}
  <style>
    .wrap{max-width:760px;margin:40px auto;padding:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px}
    .row{display:grid;gap:12px}
    .btn{appearance:none;border:none;cursor:pointer;padding:12px 16px;border-radius:12px;
         font-weight:800;background:var(--accent);color:#fff;min-height:40px}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .muted{color:var(--muted)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    a{color:#91f2c3;text-decoration:none}
  </style>
{% endblock %}

{% block content %}
  <div class="wrap">
    <header>
      <div>ğŸ” <strong>Lexinoa Pro ê²°ì œ</strong></div>
      <div><a href="/subscribe">â† ê°€ê²©ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a></div>
    </header>

    <div class="card row">
      <div>
        <h2 style="margin:0 0 6px">Pro ì›” êµ¬ë… ê²°ì œ</h2>
        <p class="muted" style="margin:0">ì¹´ë“œë¥¼ ë“±ë¡í•˜ë©´ ì²« ê²°ì œê°€ ì¦‰ì‹œ ì§„í–‰ë˜ê³ , ë‹¤ìŒë‹¬ ê°™ì€ ë‚ ì— ìë™ ì²­êµ¬ë¼ìš”.</p>
      </div>
      <div>
        <button id="btn-start" class="btn">ì¹´ë“œ ë“±ë¡í•˜ê³  ê²°ì œ ì§„í–‰</button>
        <button id="btn-cancel" class="btn ghost" onclick="history.back()">ì·¨ì†Œ</button>
      </div>
      <p id="hint" class="muted" style="margin:0;display:none"></p>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <!-- í† ìŠ¤ ìœ„ì ¯ -->
  <script src="https://js.tosspayments.com/v1"></script>
  <script nonce="{{ csp_nonce }}">
    const $btn = document.getElementById('btn-start');
    const $hint = document.getElementById('hint');

    async function startCheckout() {
      $btn.disabled = true;
      const original = $btn.textContent;
      $btn.textContent = 'ì¤€ë¹„ì¤‘â€¦';

      try {
        // ì„œë²„ì—ì„œ clientKey / successUrl / customerKey ë°›ì•„ì˜¤ê¸°
        const res = await fetch('/api/toss/checkout/start', {
          method: 'POST',
          credentials: 'include',
          headers: {'Content-Type': 'application/json'}
        });

        if (res.status === 401) {
          alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
          location.href = '/login?next=/subscribe/checkout';
          return;
        }
        if (res.status === 403) {
          alert('ì´ë©”ì¼ ì¸ì¦ í›„ ê²°ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          location.href = '/verify/require?next=/subscribe/checkout';
          return;
        }

        const data = await res.json();
        if (!data.ok) throw new Error(data.error || 'ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

        const toss = TossPayments(data.clientKey);
        await toss.requestBillingAuth('CARD', {
          customerKey: data.customerKey,
          successUrl: data.successUrl,
          failUrl: data.failUrl
        });
        // ìœ„ì ¯ì´ ìì²´ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•¨
      } catch (e) {
        console.error(e);
        $hint.style.display = 'block';
        $hint.textContent = 'ê²°ì œë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
        $btn.textContent = original;
        $btn.disabled = false;
      }
    }

    $btn.addEventListener('click', startCheckout);
  </script>
{% endblock %}
