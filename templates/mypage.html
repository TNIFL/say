{% extends "base.html" %}

{% block title %}마이페이지 | Lexinoa{% endblock %}

{% block head_extra %}
  <style>
    .container { max-width: 1100px; margin: 24px auto; padding: 16px; }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width: 980px){ .grid-2 { grid-template-columns:1fr; } }
    .kv { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .badge { display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid var(--border); font-size:.8rem; opacity:.9; }
    .badge-free  { color:#3b82f6; border-color:#3b82f6; }
    .badge-pro   { color:#22c55e; border-color:#22c55e; }
    .table { width:100%; border-collapse:collapse; }
    .table th, .table td { padding:8px; border-bottom:1px solid var(--border);}
    .muted { color: var(--muted); }
    .hint { border-left:3px solid var(--border); padding-left:10px; }
    .mini { font-size:.9rem; opacity:.9; }
    .bar { width:100%; height:10px; background:transparent; border:1px solid var(--border); border-radius:999px; overflow:hidden; }
    .bar > span { display:block; height:100%; width:0%; background:var(--accent); transition:width .3s ease; }
    .status-green { color: #22c55e; font-weight: 500; }
    .status-red { color: #ef4444; font-weight: 500; }

    .btn.danger{
      border: 1px solid #ef4444;
      color:#ef4444;
      background: transparent;
    }
    .btn.danger:hover{
      background: rgba(239,68,68,.08);
    }

    /* --- Account delete UI helpers --- */
    .divider-strong{
      margin: 14px 0;
      border: 0;
      border-top: 1px solid var(--border);
      opacity: .9;
    }
    .danger-box{
      border: 1px solid rgba(239,68,68,.55);
      border-radius: 14px;
      padding: 12px;
      background: rgba(239,68,68,.04);
    }
    .danger-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }
    .danger-title h4{ margin:0; }
    .danger-help{ margin-top:6px; }
    .inline-input{
      width: 180px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
    }

    /* job collapse */
    .job-collapse{
      overflow:hidden;
      max-height:0;
      opacity:0;
      transform: translateY(-4px);
      transition: max-height .35s ease, opacity .25s ease, transform .25s ease;
    }
    .job-collapse.open{
      max-height: 420px; /* 충분히 큰 값 */
      opacity:1;
      transform: translateY(0);
    }
    #user-job-detail{
      line-height:1.6;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container">
    <h1 style="margin: 8px 0 12px;">마이페이지</h1>

    <!-- 계정 정보 -->
    <section class="card">
      <h3>계정</h3>
      <div class="kv">
        <div><strong>{{ user.email }}</strong></div>
        <div class="muted mini">(User ID: {{ user.user_id }})</div>
        <div class="spacer"></div>
        <div>
          {% if tier == 'pro' %}<span class="badge badge-pro">PRO</span>
          {% else %}<span class="badge badge-free">FREE</span>{% endif %}
        </div>
      </div>
      <div class="muted" style="margin-top:6px;">
        이메일 인증:
        {% if user.email_verified %}
          <span class="status-green">완료</span>
        {% else %}
          <span class="status-red">미완료</span>
        {% endif %}
      </div>

      {% if not user.email_verified %}
      <form action="/verify/send" method="post" style="margin-top:10px;">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="next" value="/mypage">
        <button type="submit" class="btn small">인증 메일 보내기</button>
        <span class="small muted">구독 이용 전 인증이 필요합니다.</span>
      </form>
      {% endif %}
    </section>

    <br>

    <!-- 사용량 (공통: 심플 진행바만) -->
    <section class="card">
      <h3>이번 달 사용량</h3>
      <div class="kv">
        <div>사용: <strong>{{ used }}</strong> / {{ limit }} 회</div>
        <div class="spacer"></div>
        <div class="muted mini">남은: {{ remaining }} 회 · 등급: {{ tier|upper }}</div>
      </div>
      <div class="bar" style="margin-top:8px;">
        {% set ratio = (used / limit * 100) if limit else 0 %}
        <span style="width: {{ '%0.1f'|format(ratio if ratio < 100 else 100) }}%;"></span>
      </div>
    </section>

    <br>

    <!-- 직업 / 직업 설명 -->
    <section class="card" id="jobCard">
      <h3>직업 / 직업 설명</h3>
      <p class="small">직업에 따라 자연스러운 말투와 표현 방식이 다를 수 있습니다.</p>
      <p class="small">입력하신 직업 정보는 문장을 더 자연스럽게 순화하는 데 활용됩니다.</p>
      <p class="small">(선택사항)</p>

      {% set _job = (user.user_job or '') %}
      {% set _job_detail = (user.user_job_detail or '') %}
      {% set has_job = (_job|trim) != '' %}

      {% if has_job %}
        <div class="hint" style="margin-top:10px;">
          <div class="mini"><strong>직업</strong>: {{ _job }}</div>
          {% if (_job_detail|trim) != '' %}
            <div class="mini" style="margin-top:6px;"><strong>직업 설명</strong>: {{ _job_detail }}</div>
          {% endif %}
        </div>

        <div class="toolbar" style="margin-top:10px;">
          <button type="button" class="btn ghost small" id="jobToggleBtn">수정</button>
          <span class="spacer"></span>

          <form action="{{ url_for('mypage.mypage_delete_job') }}" method="post" style="margin:0;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn ghost small" onclick="return confirm('직업 정보를 삭제할까요?')">삭제</button>
          </form>
        </div>
      {% endif %}

      <div id="jobFormWrap"
           class="job-collapse {% if not has_job %}open{% endif %}"
           style="margin-top:12px;">
        <form id="jobForm" action="{{ url_for('mypage.mypage_update_job') }}" method="post" class="stack" style="display:grid; gap:10px;">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

          <div style="display:grid; gap:6px;">
            <label class="small" for="user-job">직업</label>
            <input
              type="text"
              id="user-job"
              name="user-job"
              placeholder="예: 개발자, 디자이너, 대학생, 마케터"
              maxlength="50"
              value="{% if not has_job %}{{ _job }}{% endif %}"
              style="width:100%;"
            >
            <div class="small muted">최대 50자</div>
          </div>

          <div style="display:grid; gap:6px;">
            <label class="small" for="user-job-detail">직업 설명</label>
            <textarea
              id="user-job-detail"
              name="user-job-detail"
              placeholder="본인 직업에 대해 자유롭게 설명해주세요. (100자 이내)"
              maxlength="100"
              rows="2"
              style="width:100%; resize:none; padding:12px; border-radius:12px; border:1px solid var(--border); background:transparent; color:var(--text);"
            >{% if not has_job %}{{ _job_detail }}{% endif %}</textarea>
            <div class="small muted"><span id="jobDetailCount">0</span>/100</div>
          </div>

          <div class="toolbar" style="margin-top:4px;">
            {% if has_job %}
              <button type="button" class="btn ghost small" id="jobCancelBtn">닫기</button>
            {% endif %}
            <span class="spacer"></span>
            <button type="submit" class="btn small" id="jobSaveBtn">
              <span class="btn-label">저장</span>
            </button>
          </div>
        </form>
      </div>

      <script nonce="{{ csp_nonce }}">
        (function(){
          const wrap = document.getElementById('jobFormWrap');
          const toggleBtn = document.getElementById('jobToggleBtn');
          const cancelBtn = document.getElementById('jobCancelBtn');
          const form = document.getElementById('jobForm');
          const job = document.getElementById('user-job');
          const detail = document.getElementById('user-job-detail');
          const countEl = document.getElementById('jobDetailCount');

          if (!wrap || !form || !job || !detail) return;

          function autosize(){
            detail.style.height = 'auto';
            detail.style.height = Math.min(detail.scrollHeight, 220) + 'px';
          }
          function updateCount(){
            const v = detail.value || '';
            if (countEl) countEl.textContent = String(v.length);
          }

          detail.addEventListener('input', () => { autosize(); updateCount(); });
          window.addEventListener('load', () => { autosize(); updateCount(); });

          function open(){
            wrap.classList.add('open');
            if (!job.value) job.value = "{{ _job|e }}";
            if (!detail.value) detail.value = `{{ _job_detail|e }}`;
            autosize(); updateCount();
            setTimeout(() => job.focus(), 60);
          }
          function close(){ wrap.classList.remove('open'); }

          if (toggleBtn) toggleBtn.addEventListener('click', () => {
            if (wrap.classList.contains('open')) close();
            else open();
          });
          if (cancelBtn) cancelBtn.addEventListener('click', close);

          const saved = "{{ session.pop('job_saved', '') }}";
          if (saved) {
            job.value = '';
            detail.value = '';
            autosize(); updateCount();
            close();
          }
        })();
      </script>
    </section>

    <br>

    <!-- 내 문의 / 피드백 -->
    <section class="card">
      <h3>내 문의 / 피드백</h3>
      {% if my_feedbacks %}
        <table class="table">
          <thead>
            <tr>
              <th style="width:110px">작성일</th>
              <th>내용</th>
              <th style="width:110px">상태</th>
              <th>관리자 답변</th>
            </tr>
          </thead>
          <tbody>
          {% for f in my_feedbacks %}
            <tr>
              <td class="small">{{ (f.created_at or '').strftime('%Y-%m-%d %H:%M') if f.created_at else '' }}</td>
              <td>{{ f.message }}</td>
              <td>
                {% if f.admin_reply %}
                  <span class="badge" style="color:#22c55e;border-color:#22c55e;">답변완료</span>
                {% else %}
                  <span class="badge" style="color:#ef4444;border-color:#ef4444;">대기</span>
                {% endif %}
              </td>
              <td>
                {% if f.admin_reply %}
                  <div style="white-space:pre-wrap">{{ f.admin_reply }}</div>
                  {% if f.replied_at %}
                    <div class="small muted" style="margin-top:4px;">{{ f.replied_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</div>
                  {% endif %}
                {% else %}
                  <span class="muted small">아직 답변이 등록되지 않았습니다.</span>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="muted">등록한 피드백이 없습니다.</div>
      {% endif %}
    </section>

    <br>

    <!-- 최근 방문 (5개) -->
    <section class="card">
      <h3>최근 방문</h3>
      {% if visits %}
        <ul class="small" style="margin:0; padding-left:16px;">
          {% for v in visits %}
            <li>
              {{ (v.created_at or '').astimezone().strftime('%m/%d %H:%M') if v.created_at else '' }}
              · <span class="muted">{{ v.path }}</span>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <div class="muted">기록이 없습니다.</div>
      {% endif %}
    </section>

    <br>

    <!-- 구독 / 결제 -->
    <section class="card">
      <h3>구독 / 결제</h3>

      {% if active_sub %}
        {% set _status = (active_sub.status or '') %}
        {% set _plan = (active_sub.plan_name or 'Pro') %}
        {% set _next = active_sub.next_billing_at %}
        {% set _cancel_at_period_end = (active_sub.cancel_at_period_end if active_sub.cancel_at_period_end is not none else false) %}
        {% set _period_end = active_sub.current_period_end if active_sub.current_period_end is not none else _next %}

        <div class="kv" style="align-items:flex-start;">
          <div style="flex:1;">
            <div class="mini">
              상태:
              <strong>{{ _status }}</strong>
              · 플랜: <strong>{{ _plan }}</strong>
            </div>

            {% if _cancel_at_period_end %}
              <div class="muted mini" style="margin-top:6px;">
                해지 예약됨 — <strong>{{ _period_end or '—' }}</strong> 까지 이용 가능하며, 다음 결제부터 과금이 중단됩니다.
              </div>
            {% else %}
              <div class="muted mini" style="margin-top:6px;">
                다음 결제일: <strong>{{ _next or '—' }}</strong>
              </div>
            {% endif %}
          </div>

          <div class="toolbar" style="display:flex; gap:8px; justify-content:flex-end;">
            <form action="{{ url_for('api_nicepay_pm.change_payment_method') }}" method="post" style="margin:0;">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button type="submit" class="btn ghost small" disabled
                      title="나이스페이먼츠 심사 완료 후 제공됩니다.">
                결제수단 변경 (준비중)
              </button>
            </form>

            {% if _cancel_at_period_end %}
              <form action="{{ url_for('billing.resume_subscription') }}" method="post" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn small"
                        onclick="return confirm('해지 예약을 취소하고 구독을 계속 유지할까요?');">
                  해지 예약 취소
                </button>
              </form>
            {% else %}
              <form action="{{ url_for('billing.cancel_subscription') }}" method="post" style="margin:0;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn danger small"
                        onclick="return confirm('구독을 취소할까요?\n\n지금 취소해도 현재 결제 기간이 끝날 때까지 Pro를 계속 이용할 수 있으며,\n다음 결제일부터 과금이 중단됩니다.');">
                  구독 취소
                </button>
              </form>
            {% endif %}
          </div>
        </div>

      {% else %}
        <p class="muted">활성 구독이 없습니다.</p>
        <a class="btn small" href="{{ url_for('subscribe.subscribe_page') }}">구독 알아보기</a>
      {% endif %}

      {% if payments %}
        <div style="height:8px"></div>
        <table class="table">
          <thead><tr><th>시각</th><th>금액</th><th>통화</th><th>상태</th></tr></thead>
          <tbody>
            {% for p in payments %}
            <tr>
              <td>{{ p.created_at }}</td>
              <td>{{ p.amount }}</td>
              <td>{{ p.currency }}</td>
              <td>{{ p.status }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      <!-- =========================
           Account Delete / Restore UI
           (placed near subscription actions)
           ========================= -->
      <hr class="divider-strong">

      <section class="danger-box" aria-label="계정 삭제">
        <div class="danger-title">
          <h4>계정 삭제</h4>
          <span class="badge" style="color:#ef4444;border-color:#ef4444;">주의</span>
        </div>

        {% if user.deleted_at %}
          <p class="small danger-help">
            현재 계정은 <strong>탈퇴 유예 상태</strong>입니다. (복구 가능)
            <br>
            완전 삭제 예정일: <strong>{{ user.purge_after }}</strong>
          </p>

          <div class="toolbar" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:10px;">
            <button type="button" class="btn small" id="btnRestoreAccount">
              계정 복구
            </button>

            <span class="spacer"></span>

            <span class="small muted">
              복구 시 기존 데이터는 되돌아오지만, 구독은 자동 복구되지 않습니다. (재구독 필요)
            </span>
          </div>

        {% else %}
          <p class="small danger-help">
            계정을 삭제하면 즉시 로그아웃되며, <strong>30일 동안 복구</strong>할 수 있습니다.
            <br>
            30일이 지나면 계정과 사용 기록은 영구적으로 삭제되며 복구할 수 없습니다.
          </p>

          <div class="kv" style="margin-top:10px;">
            <input class="inline-input" id="deleteConfirmInput" type="text" placeholder="DELETE 입력">
            <button type="button" class="btn danger small" id="btnDeleteAccount">
              계정 삭제 (30일 유예)
            </button>
            <span class="spacer"></span>
            <span class="small muted">실수 방지를 위해 DELETE를 입력해야 합니다.</span>
          </div>
        {% endif %}
      </section>

      <script nonce="{{ csp_nonce }}">
      (function(){
        const csrf = "{{ csrf_token() }}";

        const btnDelete = document.getElementById("btnDeleteAccount");
        const confirmInput = document.getElementById("deleteConfirmInput");
        const btnRestore = document.getElementById("btnRestoreAccount");

        async function postJson(url, body){
          const r = await fetch(url, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": csrf
            },
            body: JSON.stringify(body || {})
          });
          const data = await r.json().catch(() => ({}));
          return { ok: r.ok, status: r.status, data };
        }

        if (btnDelete) {
          btnDelete.addEventListener("click", async () => {
            const v = (confirmInput && confirmInput.value || "").trim();
            if (v !== "DELETE") {
              alert("DELETE를 정확히 입력해주세요.");
              return;
            }

            const ok = confirm("정말 계정을 삭제할까요?\n\n- 즉시 로그아웃됩니다.\n- 30일 안에는 복구 가능합니다.\n- 30일 이후에는 영구 삭제됩니다.");
            if (!ok) return;

            const { ok: reqOk, data } = await postJson("/api/account/delete", {
              confirm: "DELETE",
              reason: "mypage"
            });

            if (!reqOk || !data.ok) {
              alert("계정 삭제 요청에 실패했습니다. 잠시 후 다시 시도해주세요.");
              return;
            }

            alert("계정 삭제가 접수되었습니다. 30일 이내에 복구할 수 있습니다.");
            window.location.href = "/logout";
          });
        }

        if (btnRestore) {
          btnRestore.addEventListener("click", async () => {
            const ok = confirm("계정을 복구할까요?\n\n복구 후에는 다시 로그인/이용이 가능합니다.\n단, 구독은 자동 복구되지 않으며 재구독이 필요합니다.");
            if (!ok) return;

            const { ok: reqOk, data } = await postJson("/api/account/restore", {});

            if (!reqOk || !data.ok) {
              const msg = (data && data.error) ? data.error : "unknown";
              if (msg === "purge_expired") {
                alert("복구 기간(30일)이 만료되어 복구할 수 없습니다.");
              } else {
                alert("계정 복구에 실패했습니다. 잠시 후 다시 시도해주세요.");
              }
              return;
            }

            alert("계정이 복구되었습니다. 다시 이용하실 수 있습니다. (구독은 재구독 필요)");
            window.location.reload();
          });
        }
      })();
      </script>

    </section>
  </div>
{% endblock %}
```
