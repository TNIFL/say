{% extends "base.html" %}

{% block title %}{{ _("Lexinoa - ë¬¸ì¥ ë‹¤ë“¬ê¸° | ë§íˆ¬ êµì •") }}{% endblock %}
{% block description %}
  {{ _("ì´ë©”ì¼, ë³´ê³ ì„œ, ì¹´ì¹´ì˜¤í†¡ ë©”ì‹œì§€ê¹Œì§€ ë” ìì—°ìŠ¤ëŸ½ê³  ì •ì¤‘í•œ ë¬¸ì¥ìœ¼ë¡œ ë°”ê¿”ì¤ë‹ˆë‹¤. LexinoaëŠ” ìƒí™©ë³„ ë§ì¶¤ ì–´íˆ¬ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ì œì•ˆí•˜ëŠ” ì»¤ë®¤ë‹ˆì¼€ì´ì…˜ ë³´ì¡° ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.") }}
{% endblock %}

{% block head_extra %}
  {# --- ê´‘ê³  ì œì–´ê°’ (app.pyì—ì„œ ë‚´ë ¤ì˜´) --- #}
  {# ADS_PROVIDER: 'adsense' | 'kakao' | 'naver' ... #}
  {# ADSENSE_CLIENT: 'ca-pub-xxxx'  #}
  {% set _client_id = ADSENSE_CLIENT|default('', true) %}
  {% set _show_ads = SHOW_ADS and g.show_ads_here and ADS_PROVIDER == 'adsense' and _client_id %}

  {# í™•ì¥ í”„ë¡œê·¸ë¨ ë§í¬(ì‹¬ì‚¬ í†µê³¼ í›„ ì‹¤ì œ URLë¡œ êµì²´) #}
  {% set _ext_url = EXTENSION_URL|default('https://chromewebstore.google.com/detail/lexinoa-%EB%AC%B8%EC%9E%A5-%EC%88%9C%ED%99%94-%EB%8F%84%EC%9A%B0%EB%AF%B8/ggmgbbhaidapcbjkmelimhbpagpiejje?hl=ko', true) %}

  {# AdSense ë¡œë” ìŠ¤í¬ë¦½íŠ¸ #}
  {% if _show_ads %}
    <script async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ _client_id }}"
      crossorigin="anonymous" nonce="{{ csp_nonce }}"></script>
  {% endif %}
{% endblock %}

{% block content %}
    {# ---------- ê´‘ê³  1: í—¤ë” ì•„ë˜ ë°˜ì‘í˜• ë°°ë„ˆ ---------- #}
    {% include "_ads.html" %}
    {% if _show_ads %}
      {% from "_ads.html" import display_responsive, in_article %}
      {{ display_responsive("1234567890", _client_id) }}
    {% endif %}

    {# ===== í™•ì¥ í”„ë¡œê·¸ë¨ ë³´ì¡° CTA (ìƒë‹¨ ì¹´ë“œí˜•, ë” í™”ì‚¬í•˜ê²Œ + ì„¤ì¹˜ ì‹œ ìˆ¨ê¹€) ===== #}
    <section id="extPromoCard" class="card" style="
      margin-top:12px;
      border: 1px solid rgba(59,130,246,.28);
      background: linear-gradient(135deg, rgba(59,130,246,.18), rgba(14,165,233,.14), rgba(99,102,241,.12));
      box-shadow: 0 14px 40px rgba(2, 6, 23, .12);
      display: none;">
      <div style="display:flex; gap:14px; align-items:center; justify-content:space-between; flex-wrap:wrap;">
        <div style="display:flex; gap:12px; align-items:flex-start; min-width:260px;">
          <div aria-hidden="true" style="
            width:40px; height:40px; border-radius:12px;
            background: rgba(255,255,255,.65);
            display:flex; align-items:center; justify-content:center;
            box-shadow: 0 8px 18px rgba(2, 6, 23, .12);">
            <span class="brand-mark" aria-hidden="true">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 5.5C4 4.12 5.34 3 7 3h10c1.66 0 3 1.12 3 2.5v7c0 1.38-1.34 2.5-3 2.5H11l-3.6 3.1c-.52.45-1.4.09-1.4-.55V15H7c-1.66 0-3-1.12-3-2.5v-7Z"></path></svg>
            </span>
          </div>
          <div>
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <h3 style="margin-bottom:2px;">{{ _("í¬ë¡¬ í™•ì¥ìœ¼ë¡œ ë” ë¹ ë¥´ê²Œ") }}</h3>
              <span class="small" style="
                padding:2px 8px; border-radius:999px;
                background: rgba(255,255,255,.55);
                border: 1px solid rgba(59,130,246,.18);
                color: rgba(15,23,42,.85);">
                NEW
              </span>
            </div>
            <p class="small hint" style="margin:0;">
              {{ _("ë“œë˜ê·¸Â·ìš°í´ë¦­ìœ¼ë¡œ ë°”ë¡œ ë¬¸ì¥ ìˆœí™”/ë§íˆ¬ êµì •ì„ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.") }}
            </p>
          </div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <a class="btn small"
             href="{{ _ext_url }}"
             target="_blank" rel="noopener noreferrer"
             style="white-space:nowrap;">
            {{ _("í¬ë¡¬ ì›¹ìŠ¤í† ì–´ì—ì„œ ì„¤ì¹˜") }}
          </a>
          <button type="button" id="extPromoClose"
                  class="btn ghost small"
                  aria-label="{{ _("ë‹«ê¸°") }}"
                  style="white-space:nowrap;">
            âœ•
          </button>
        </div>
      </div>
    </section>

    <form id="polishForm" class="stack" method="post" action="/">
      <div id="bootstrap"
           data-selected-categories='{{ selected_categories|tojson|safe }}'
           data-selected-tones='{{ selected_tones|tojson|safe }}'
           data-honorific='{{ "true" if honorific_checked else "false" }}'
           data-opener='{{ "true" if opener_checked else "false" }}'
           data-emoji='{{ "true" if emoji_checked else "false" }}'
           data-is-pro='{{ "true" if (is_pro|default(False)) else "false" }}'></div>

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="provider" value="claude">

      <!-- ì…ë ¥ -->
      <section class="card">
        <h3>{{ _("ì…ë ¥") }}</h3>
        <p class="small hint">{{ _("ì „ë‹¬í•  ë¬¸ì¥ì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.") }}</p>
        <textarea id="input_text" name="input_text" placeholder="{{ _("ì˜ˆ) ì™œ ì´ë ‡ê²Œ ëŠ¦ê²Œ ë³´ë‚´ì„¸ìš”? ë‹¤ìŒë¶€í„´ ì œë•Œ ë³´ë‚´ì„¸ìš”.") }}">{{ input_text or "" }}</textarea>
      </section>

      <!-- ì¹´í…Œê³ ë¦¬ & ë§íˆ¬ -->
      <section class="card">
        <div class="section-header">
          <h3>{{ _("ì¹´í…Œê³ ë¦¬ & ë§íˆ¬ ì„¤ì • (ì„ íƒ ì‹œ ìë™ ì¶”ê°€)") }}</h3>
          <div class="toolbar-right">
            {% if is_pro %}
              <span class="template-badge badge-pro">Pro</span>&nbsp;
              <select id="templateSelect"
                      class="template-select"
                      aria-label="{{ _('í…œí”Œë¦¿ ì„ íƒ') }}"
                      data-i18n-placeholder="{{ _('í…œí”Œë¦¿ ì„ íƒâ€¦') }}"
                      data-i18n-hint1="{{ _('í…œí”Œë¦¿ì„ ì €ì¥í•´ì„œ') }}"
                      data-i18n-hint2="{{ _('ìƒí™©ì— ë§ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.') }}"
                      data-i18n-hint3="{{ _('ì˜ˆ) ì—…ë¬´, ì •ì¤‘í•˜ê²Œ, ì¡´ëŒ“ë§ ì„ íƒ') }}">
                <option value="" selected>{{ _('í…œí”Œë¦¿ ì„ íƒâ€¦') }}</option>
              </select>
              <button type="button" class="btn small secondary" id="btnTemplateAdd">{{ _("í…œí”Œë¦¿ ì¶”ê°€") }}</button>
              <button type="button" class="btn ghost small" id="btnTemplateDelete">{{ _("í…œí”Œë¦¿ ì‚­ì œ") }}</button>
              <span class="spacer"></span>
              <button type="button" class="btn ghost small" id="resetTemplateBtn" style="margin-left:auto;">{{ _("ì´ˆê¸°í™”") }}</button>
            {% else %}
              <span class="template-badge badge-locked">{{ _("ğŸ”’ Pro ì „ìš©") }}</span>
              <select id="templateSelect"
                      class="template-select"
                      aria-label="{{ _('í…œí”Œë¦¿ ì„ íƒ') }}"
                      data-i18n-placeholder="{{ _('í…œí”Œë¦¿ ì„ íƒâ€¦') }}"
                      data-i18n-hint1="{{ _('í…œí”Œë¦¿ì„ ì €ì¥í•´ì„œ') }}"
                      data-i18n-hint2="{{ _('ìƒí™©ì— ë§ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.') }}"
                      data-i18n-hint3="{{ _('ì˜ˆ) ì—…ë¬´, ì •ì¤‘í•˜ê²Œ, ì¡´ëŒ“ë§ ì„ íƒ') }}">
                <option value="" selected>{{ _('í…œí”Œë¦¿ ì„ íƒâ€¦') }}</option>
              </select>
              <a class="btn small" href="{{ url_for('subscribe.subscribe_page') }}">{{ _("êµ¬ë…í•˜ê¸°") }}</a>
              <span class="spacer"></span>
              <button type="button" class="btn ghost small" id="resetTemplateBtn" style="margin-left:auto;">{{ _("ì´ˆê¸°í™”") }}</button>
            {% endif %}
          </div>
        </div>

        <div class="row cols-2">
          <!-- ì¹´í…Œê³ ë¦¬ -->
          <div>
            <label class="small" for="categorySelect">{{ _("ì¹´í…Œê³ ë¦¬ ì„ íƒ") }}</label>
            <div class="input-group">
              <select id="categorySelect" aria-label="{{ _("ì¹´í…Œê³ ë¦¬ ì„ íƒ") }}">
                <option value="" disabled selected>{{ _("ì¹´í…Œê³ ë¦¬ ì„ íƒâ€¦") }}</option>
                <option value="general">{{ _("ì¼ë°˜") }}</option>
                <option value="work">{{ _("ì—…ë¬´") }}</option>
                <option value="support">{{ _("ê³ ê°ì‘ëŒ€") }}</option>
                <option value="apology">{{ _("ì‚¬ê³¼") }}</option>
                <option value="inquiry">{{ _("ë¬¸ì˜") }}</option>
                <option value="thanks">{{ _("ê°ì‚¬") }}</option>
                <option value="request">{{ _("ìš”ì²­") }}</option>
                <option value="guidance">{{ _("ì•ˆë‚´") }}</option>
                <option value="report/approval">{{ _("ë³´ê³ /ê²°ì œ") }}</option>
                <option value="feedback">{{ _("í”¼ë“œë°±") }}</option>
                <option value="refusal/alternative">{{ _("ê±°ì ˆ/ëŒ€ì•ˆ") }}</option>
              </select>
            </div>
            <div class="chipbox" id="categoryChips"></div>
            <div id="categoryHidden"></div>
          </div>

          <!-- ë§íˆ¬ -->
          <div>
            <label class="small" for="toneSelect">{{ _("ë§íˆ¬ ì„ íƒ") }}</label>
            <div class="input-group">
              <select id="toneSelect" aria-label="{{ _("ë§íˆ¬ ì„ íƒ") }}">
                <option value="" disabled selected>{{ _("ë§íˆ¬ ì„ íƒâ€¦") }}</option>
                <option value="soft">{{ _("ë¶€ë“œëŸ½ê²Œ") }}</option>
                <option value="polite">{{ _("ì •ì¤‘í•˜ê²Œ") }}</option>
                <option value="concise">{{ _("ê°„ê²°í•˜ê²Œ") }}</option>
                <option value="report">{{ _("ë³´ê³ ì„œì²´") }}</option>
                <option value="friendly">{{ _("ì¹œê·¼í•˜ê²Œ") }}</option>
                <option value="warmly">{{ _("ë”°ë“¯í•˜ê²Œ") }}</option>
                <option value="calmly">{{ _("ì°¨ë¶„í•˜ê²Œ") }}</option>
                <option value="formally">{{ _("ê²©ì‹ìˆê²Œ") }}</option>
                <option value="clearly">{{ _("ëª…í™•í•˜ê²Œ") }}</option>
                <option value="without_emotion">{{ _("ê°ì • ì—†ì´(ì¤‘ë¦½)") }}</option>
              </select>
            </div>
            <div class="chipbox" id="toneChips"></div>
            <div id="toneHidden"></div>
          </div>
        </div>

        <!-- ì²´í¬ë°•ìŠ¤ -->
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" id="honorific" name="honorific_checked" value="on" {% if honorific_checked %}checked{% endif %}>
            <span>{{ _("ì¡´ëŒ“ë§ ìœ ì§€") }}</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="opener" name="opener_checked" value="on" {% if opener_checked %}checked{% endif %}>
            <span>{{ _("ì™„ì¶©ë¬¸Â·ì¸ì‚¬ ì¶”ê°€") }}</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="emoji" name="emoji_checked" value="on" {% if emoji_checked %}checked{% endif %}>
            <span>{{ _("ì´ëª¨ì§€ í—ˆìš© ğŸ™‚") }}</span>
          </label>
        </div>

        <div class="toolbar" style="margin-top:8px;">
          <span class="small">{{ _("ì„ íƒí•œ ì¹©ì„ í´ë¦­í•˜ë©´ ì œê±°ë©ë‹ˆë‹¤.") }}</span>
          <span class="spacer"></span>
          <p class="small hint">{{ _("ë‹¨ì¶•í‚¤: âŒ˜/Ctrl + Enter") }}</p>
          <button type="submit" class="btn" id="submitBtn">
            <span class="spinner" aria-hidden="true"></span>
            <span class="btn-label">{{ _("ë²ˆì—­í•˜ê¸°") }}</span>
          </button>
        </div>

        {% if not is_pro %}
          <p class="lock-note muted" style="margin-top:8px;">{{ _("â€» í…œí”Œë¦¿ ì €ì¥Â·ë¶ˆëŸ¬ì˜¤ê¸°ëŠ” êµ¬ë…(Pro)ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.") }}</p>
        {% endif %}
      </section>

      <!-- ì¶œë ¥ -->
      <section class="card">
        <h3>{{ _("ì¶œë ¥") }}</h3>
        <div id="usageInfo" style="font-size:0.9rem; opacity:0.75; color:var(--muted); margin-right:4px;"></div>
        <div id="output_text" class="output">{{ output_text or _("ì„œë²„ì—ì„œ ì²˜ë¦¬ëœ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.") }}</div>
        <div class="toolbar" style="margin-top:8px;">
          <span class="small">{{ _("â€» ì›í•˜ëŠ” ê²°ê³¼ê°€ ë‚˜ì˜¤ì§€ ì•Šì„ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤") }}</span>
          <span class="spacer"></span>
        </div>
      </section>
    </form>

    {# ---------- ê´‘ê³  2: ë³¸ë¬¸ ì¤‘ê°„ ì¸ì•„í‹°í´ ---------- #}
    {% if _show_ads %}
      {% from "_ads.html" import in_article %}
      {{ in_article("0987654321", _client_id) }}
    {% endif %}

    {# ---------- ê´‘ê³  3: í‘¸í„° ìœ„ ë°˜ì‘í˜• ---------- #}
    {% if _show_ads %}
      {% from "_ads.html" import display_responsive %}
      {{ display_responsive("1122334455", _client_id) }}
    {% endif %}

  {# ---------- Pro ì „ìš© í…œí”Œë¦¿ ë‹¤ì´ì–¼ë¡œê·¸ ---------- #}
  {% if is_pro %}
  <dialog id="tplDialog" class="tpl-dialog">
    <form method="dialog" class="tpl-dialog-inner">
      <header class="tpl-dialog-header">
        <h3>{{ _("í…œí”Œë¦¿ ì €ì¥") }}</h3>
        <button type="button" id="tplClose" class="btn ghost small" aria-label="{{ _("ë‹«ê¸°") }}">âœ•</button>
      </header>

      <div class="tpl-dialog-body">
        <div class="field">
          <label for="tplTitle">{{ _("í…œí”Œë¦¿ ì´ë¦„") }}</label>
          <input type="text" id="tplTitle" placeholder="{{ _("ì˜ˆ) ì—…ë¬´Â·ì •ì¤‘Â·ì¡´ëŒ“ë§") }}" />
        </div>

        <div class="field">
          <label for="tplCategory">{{ _("ì¹´í…Œê³ ë¦¬") }}</label>
          <select id="tplCategory">
            <option value="">{{ _("ì„ íƒ ì•ˆ í•¨") }}</option>
            <option value="general">{{ _("ì¼ë°˜") }}</option>
            <option value="work">{{ _("ì—…ë¬´") }}</option>
            <option value="support">{{ _("ê³ ê°ì‘ëŒ€") }}</option>
            <option value="apology">{{ _("ì‚¬ê³¼") }}</option>
            <option value="inquiry">{{ _("ë¬¸ì˜") }}</option>
            <option value="thanks">{{ _("ê°ì‚¬") }}</option>
            <option value="request">{{ _("ìš”ì²­") }}</option>
            <option value="guidance">{{ _("ì•ˆë‚´") }}</option>
            <option value="report/approval">{{ _("ë³´ê³ /ê²°ì œ") }}</option>
            <option value="feedback">{{ _("í”¼ë“œë°±") }}</option>
          </select>
        </div>

        <div class="field">
          <label for="tplTone">{{ _("ë§íˆ¬") }}</label>
          <select id="tplTone">
            <option value="">{{ _("ì„ íƒ ì•ˆ í•¨") }}</option>
            <option value="soft">{{ _("ë¶€ë“œëŸ½ê²Œ") }}</option>
            <option value="polite">{{ _("ì •ì¤‘í•˜ê²Œ") }}</option>
            <option value="concise">{{ _("ê°„ê²°í•˜ê²Œ") }}</option>
            <option value="report">{{ _("ë³´ê³ ì„œì²´") }}</option>
            <option value="friendly">{{ _("ì¹œê·¼í•˜ê²Œ") }}</option>ê²Œ
            <option value="warmly">{{ _("ë”°ë“¯í•˜ê²Œ") }}</option>
            <option value="calmly">{{ _("ì°¨ë¶„í•˜ê²Œ") }}</option>
            <option value="formally">{{ _("ê²©ì‹ìˆê²Œ") }}</option>
            <option value="clearly">{{ _("ëª…í™•í•˜ê²Œ") }}</option>
            <option value="without_emotion">{{ _("ê°ì • ì—†ì´(ì¤‘ë¦½)") }}</option>
          </select>
        </div>

        <div class="field checkbox-group">
          <label>
            <input type="checkbox" id="tplHonorific" />
            <span>{{ _("ì¡´ëŒ“ë§ ìœ ì§€") }}</span>
          </label>
          <label>
            <input type="checkbox" id="tplOpener" />
            <span>{{ _("ì™„ì¶©ë¬¸Â·ì¸ì‚¬ ì¶”ê°€") }}</span>
          </label>
          <label>
            <input type="checkbox" id="tplEmoji" />
            <span>{{ _("ì´ëª¨ì§€ í—ˆìš© ğŸ™‚") }}</span>
          </label>
        </div>
      </div>

      <footer class="tpl-dialog-footer">
        <button type="button" class="btn ghost small" id="tplCancel">{{ _("ì·¨ì†Œ") }}</button>
        <button type="button" class="btn small" id="tplSave">{{ _("ì €ì¥") }}</button>
      </footer>
    </form>
  </dialog>
  {% endif %}

  <div id="cookie-banner" style="position:fixed; left:16px; right:16px; bottom:16px; padding:10px; background:#111; color:#fff; border-radius:10px; display:none; z-index:9999;">
    {{ _("ì´ ì‚¬ì´íŠ¸ëŠ” ì„œë¹„ìŠ¤ ì œê³µ ë° ê´‘ê³ ë¥¼ ìœ„í•´ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.") }}
    <a href="/privacy" style="color:#8ec5ff;">{{ _("ìì„¸íˆ") }}</a>
    <button id="cookie-accept" class="btn" style="margin-left:8px; padding:6px 10px; border-radius:8px; background:#3b82f6; color:#fff; border:0;">{{ _("ë™ì˜") }}</button>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/mainpage.js') }}" defer></script>

  {# ---- JS i18n bridge (for inline scripts) ---- #}
  <script nonce="{{ csp_nonce }}">
    window.I18N = Object.assign(window.I18N || {}, {
      "input.empty": {{ _("ì‚¬ìš©ì ì…ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.")|tojson }},
    });

    window.t = window.t || function(key, vars, fallback) {
      var s = (window.I18N && window.I18N[key]) || fallback || key;
      if (vars && typeof vars === "object") {
        for (var k in vars) {
          if (!Object.prototype.hasOwnProperty.call(vars, k)) continue;
          s = s.split("%(" + k + ")s").join(String(vars[k]));
        }
      }
      return s;
    };
  </script>

  <script nonce="{{ csp_nonce }}">
    // Shortcut: Cmd/Ctrl + Enter (only when input is focused)
    document.addEventListener("keydown", (e) => {
      const isCmdEnter = (e.metaKey || e.ctrlKey) && e.key === "Enter";
      if (!isCmdEnter) return;

      if (document.activeElement?.id !== "input_text") return;

      e.preventDefault();

      const input = document.getElementById("input_text");
      const text = (input?.value || "").trim();
      if (!text) {
        alert(window.t("input.empty", null, "No input."));
        return;
      }

      document.getElementById("polishForm")?.requestSubmit?.();
    });

    (function(){
      try {
        const key = "lexinoa_cookie_ok_v1";
        const banner = document.getElementById("cookie-banner");
        const btn = document.getElementById("cookie-accept");

        if (!banner || !btn) return;

        if (!localStorage.getItem(key)) {
          banner.style.display = "block";
        }
        btn.addEventListener("click", function(){
          localStorage.setItem(key, "1");
          banner.style.display = "none";
        });
      } catch(e) {}
    })();

    (function(){
      try {
        const installedKey = "lexinoa_ext_installed_v1";
        const hideUntilKey = "lexinoa_ext_promo_hide_until_v1";

        const now = Date.now();
        const hideUntil = Number(localStorage.getItem(hideUntilKey) || "0");
        const isInstalled = (localStorage.getItem(installedKey) === "1");

        const card = document.getElementById("extPromoCard");
        const closeBtn = document.getElementById("extPromoClose");

        if (!card) return;

        if (isInstalled) return;

        // If you want to respect hide-until, uncomment:
        // if (now <= hideUntil) return;

        card.style.display = "block";

        closeBtn?.addEventListener("click", function(){
          const days14 = 14 * 24 * 60 * 60 * 1000;
          localStorage.setItem(hideUntilKey, String(Date.now() + days14));
          card.style.display = "none";
        });
      } catch(e) {}
    })();
  </script>
{% endblock %}
