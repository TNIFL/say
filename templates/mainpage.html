{% extends "base.html" %}

{% block title %}Lexinoa - 문장 다듬기 | 말투 교정{% endblock %}
{% block description %}AI가 이메일, 보고서, 카카오톡 메시지까지 더 자연스럽고 정중한 문장으로 바꿔줍니다. Lexinoa는 상황별 맞춤 어투를 실시간으로 제안하는 커뮤니케이션 보조 서비스입니다.{% endblock %}

{% block head_extra %}
  {# --- 광고 제어값 (app.py에서 내려옴) --- #}
  {# ADS_PROVIDER: 'adsense' | 'kakao' | 'naver' ... #}
  {# ADSENSE_CLIENT: 'ca-pub-xxxx'  #}
  {% set _client_id = ADSENSE_CLIENT|default('', true) %}
  {% set _show_ads = SHOW_ADS and g.show_ads_here and ADS_PROVIDER == 'adsense' and _client_id %}

  {# AdSense 로더 스크립트 #}
  {% if _show_ads %}
    <script async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client={{ _client_id }}"
      crossorigin="anonymous" nonce="{{ csp_nonce }}"></script>
  {% endif %}
{% endblock %}

{% block content %}
    {# ---------- 광고 1: 헤더 아래 반응형 배너 ---------- #}
    {% include "_ads.html" %}
    {% if _show_ads %}
      {% from "_ads.html" import display_responsive, in_article %}
      {{ display_responsive("1234567890", _client_id) }}
    {% endif %}

    <form id="polishForm" class="stack" method="post" action="/">
      <div id="bootstrap"
           data-selected-categories='{{ selected_categories|tojson|safe }}'
           data-selected-tones='{{ selected_tones|tojson|safe }}'
           data-honorific='{{ 'true' if honorific_checked else 'false' }}'
           data-opener='{{ 'true' if opener_checked else 'false' }}'
           data-emoji='{{ 'true' if emoji_checked else 'false' }}'
           data-is-pro='{{ 'true' if (is_pro|default(False)) else 'false' }}'></div>

      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <!-- 입력 -->
      <section class="card">
        <h3>입력</h3>
        <p class="small hint">전달할 문장을 아래에 입력하세요.</p>
        <textarea id="input_text" name="input_text" placeholder="예) 왜 이렇게 늦게 보내세요? 다음부턴 제때 보내세요.">{{ input_text or "" }}</textarea>
      </section>
      <input type="hidden" name="provider" value="claude">

      <!-- 카테고리 & 말투 -->
      <section class="card">
        <div class="section-header">
          <h3>카테고리 & 말투 설정 (선택 시 자동 추가)</h3>
          <div class="toolbar-right">
            {% if is_pro %}
              <span class="template-badge badge-pro">Pro</span>&nbsp;
              <select id="templateSelect" class="template-select" aria-label="템플릿 선택">
                <option value="" selected>템플릿 선택…</option>
              </select>
              <button type="button" class="btn small secondary" id="btnTemplateAdd">템플릿 추가</button>
              <button type="button" class="btn ghost small" id="btnTemplateDelete">템플릿 삭제</button>
              <span class="spacer"></span>
              <button type="button" class="btn ghost small" id="resetTemplateBtn" style="margin-left:auto;">초기화</button>
            {% else %}
              <span class="template-badge badge-locked">🔒 Pro 전용</span>
              <select id="templateSelect" class="template-select" aria-label="템플릿 선택">
                <option value="" selected>템플릿 선택...</option>
                <option>템플릿을 저장해서 </option>
                <option>상황에 맞게 사용할 수 있습니다.</option>
                <option>예) 업무, 정중하게, 존댓말 선택</option>
              </select>
              <a class="btn small" href="{{ url_for('subscribe_page') }}">구독하기</a>
              <span class="spacer"></span>
              <button type="button" class="btn ghost small" id="resetTemplateBtn" style="margin-left:auto;">초기화</button>
            {% endif %}
          </div>
        </div>

        <div class="row cols-2">
          <!-- 카테고리 -->
          <div>
            <label class="small" for="categorySelect">카테고리 선택</label>
            <div class="input-group">
              <select id="categorySelect" aria-label="카테고리 선택">
                <option value="" disabled selected>카테고리 선택…</option>
                <option value="general">일반</option>
                <option value="work">업무</option>
                <option value="support">고객응대</option>
                <option value="apology">사과</option>
                <option value="inquiry">문의</option>
                <option value="thanks">감사</option>
                <option value="request">요청</option>
<option value="guidance">안내</option>
                <option value="report/approval">보고/결제</option>
                <option value="feedback">피드백</option>
              </select>
            </div>
            <div class="chipbox" id="categoryChips"></div>
            <div id="categoryHidden"></div>
          </div>

          <!-- 말투 -->
          <div>
            <label class="small" for="toneSelect">말투 선택</label>
            <div class="input-group">
              <select id="toneSelect" aria-label="말투 선택">
                <option value="" disabled selected>말투 선택…</option>
                <option value="soft">부드럽게</option>
                <option value="polite">정중하게</option>
                <option value="concise">간결하게</option>
                <option value="report">보고서체</option>
                <option value="friendly">친근하게</option>
                <option value="warmly">따듯하게</option>
                <option value="calmly">차분하게</option>
                <option value="formally">격식있게</option>
                <option value="clearly">명확하게</option>
                <option value="without_emotion">감정 없이(중립)</option>
              </select>
            </div>
            <div class="chipbox" id="toneChips"></div>
            <div id="toneHidden"></div>
          </div>
        </div>

        <!-- 체크박스 -->
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" id="honorific" name="honorific_checked" value="on" {% if honorific_checked %}checked{% endif %}>
            <span>존댓말 유지</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="opener" name="opener_checked" value="on" {% if opener_checked %}checked{% endif %}>
            <span>완충문·인사 추가</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="emoji" name="emoji_checked" value="on" {% if emoji_checked %}checked{% endif %}>
            <span>이모지 허용 🙂</span>
          </label>
        </div>

        <div class="toolbar" style="margin-top:8px;">
          <span class="small">선택한 칩을 클릭하면 제거됩니다.</span>
          <span class="spacer"></span>
          <button type="submit" class="btn" id="submitBtn">
            <span class="spinner" aria-hidden="true"></span>
            <span class="btn-label">번역하기</span>
          </button>
        </div>

        {% if not is_pro %}
        <p class="lock-note muted" style="margin-top:8px;">※ 템플릿 저장·불러오기는 구독(Pro)에서 사용할 수 있습니다.</p>
        {% endif %}
      </section>

      <!-- 출력 -->
      <section class="card">
        <h3>출력</h3>
        <div id="usageInfo" style="font-size:0.9rem; opacity:0.75; color:var(--muted); margin-right:4px;"></div>
        <div id="output_text" class="output">{{ output_text or "서버에서 처리된 결과가 여기에 표시됩니다." }}</div>
        <div class="toolbar" style="margin-top:8px;">
          <span class="small">※ 원하는 결과가 나오지 않을 수도 있습니다</span>
          <span class="spacer"></span>
        </div>
      </section>
    </form>

    {# ---------- 광고 2: 본문 중간 인아티클 ---------- #}
    {% if _show_ads %}
      {{ in_article("0987654321", _client_id) }}
    {% endif %}

    {# ---------- 광고 3: 푸터 위 반응형 ---------- #}
    {% if _show_ads %}
      {{ display_responsive("1122334455", _client_id) }}
    {% endif %}

  {# ---------- Pro 전용 템플릿 다이얼로그 ---------- #}
  {% if is_pro %}
  <dialog id="tplDialog" class="tpl-dialog">
    <form method="dialog" class="tpl-dialog-inner">
      <header class="tpl-dialog-header">
        <h3>템플릿 저장</h3>
        <button type="button" id="tplClose" class="btn ghost small" aria-label="닫기">✕</button>
      </header>

      <div class="tpl-dialog-body">
        <div class="field">
          <label for="tplTitle">템플릿 이름</label>
          <input type="text" id="tplTitle" placeholder="예) 업무·정중·존댓말" />
        </div>

        <div class="field">
          <label for="tplCategory">카테고리</label>
          <select id="tplCategory">
            <option value="">선택 안 함</option>
            <option value="general">일반</option>
            <option value="work">업무</option>
            <option value="support">고객응대</option>
            <option value="apology">사과</option>
            <option value="inquiry">문의</option>
            <option value="thanks">감사</option>
            <option value="request">요청</option>
            <option value="guidence">안내</option>
            <option value="report/approval">보고/결제</option>
            <option value="feedback">피드백</option>
          </select>
        </div>

        <div class="field">
          <label for="tplTone">말투</label>
          <select id="tplTone">
            <option value="">선택 안 함</option>
            <option value="soft">부드럽게</option>
            <option value="polite">정중하게</option>
            <option value="concise">간결하게</option>
            <option value="report">보고서체</option>
            <option value="friendly">친근하게</option>
            <option value="warmly">따듯하게</option>
            <option value="calmly">차분하게</option>
            <option value="formally">격식있게</option>
            <option value="clearly">명확하게</option>
            <option value="without_emotion">감정 없이(중립)</option>
          </select>
        </div>

        <div class="field checkbox-group">
          <label>
            <input type="checkbox" id="tplHonorific" />
            <span>존댓말 유지</span>
          </label>
          <label>
            <input type="checkbox" id="tplOpener" />
            <span>완충문·인사 추가</span>
          </label>
          <label>
            <input type="checkbox" id="tplEmoji" />
            <span>이모지 허용 🙂</span>
          </label>
        </div>
      </div>

      <footer class="tpl-dialog-footer">
        <button type="button" class="btn ghost small" id="tplCancel">취소</button>
        <button type="button" class="btn small" id="tplSave">저장</button>
      </footer>
    </form>
  </dialog>
  {% endif %}

  <div id="cookie-banner" style="position:fixed; left:16px; right:16px; bottom:16px; padding:10px; background:#111; color:#fff; border-radius:10px; display:none; z-index:9999;">
    이 사이트는 서비스 제공 및 광고를 위해 쿠키를 사용할 수 있습니다.
    <a href="/privacy" style="color:#8ec5ff;">자세히</a>
    <button id="cookie-accept" class="btn" style="margin-left:8px; padding:6px 10px; border-radius:8px; background:#3b82f6; color:#fff; border:0;">동의</button>
  </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/mainpage.js') }}" defer></script>
  <script nonce="{{ csp_nonce }}">
    (function(){
      try {
        const key = "lexinoa_cookie_ok_v1";
        if (!localStorage.getItem(key)) {
          document.getElementById("cookie-banner").style.display = "block";
        }
        document.getElementById("cookie-accept").addEventListener("click", function(){
          localStorage.setItem(key, "1");
          document.getElementById("cookie-banner").style.display = "none";
        });
      } catch(e) {}
    })();
  </script>
{% endblock %}
