{% extends "base.html" %}

{% block title %}Lexinoa - 핵심 요약 / 정리{% endblock %}
{% block description %}긴 한국어 글을 핵심만 깔끔하게 요약해 드립니다. 불필요한 수식을 줄이고 결론/근거 중심으로 정리합니다.{% endblock %}

{% block head_extra %}
  <style>
    /* 페이지 전용(필요 최소한) */
    .wrap { max-width: 920px; margin: 24px auto; padding: 0 16px; }
    .outta { white-space: pre-wrap; min-height: 200px; }
    .toolbar-inline { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
    .hint { font-size:.85rem; opacity:.8; }
    textarea#sm-text { resize: vertical; }
  </style>
{% endblock %}

{% block content %}
    <div class="wrap">
      <h1 style="font-size:22px; margin:0 0 12px">핵심 요약 / 정리</h1>

      <!-- form 구조만 유지 (submit은 사용하지 않음) -->
      <form id="sm-form" class="stack card" method="post" action="/api/summarize">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <!-- 입력 -->
        <section class="stack">
          <h3>입력</h3>
          <p class="small hint">긴 글을 붙여넣으면 핵심만 간결하게 요약합니다. (최대 약 8,000자)</p>
          <textarea id="sm-text" name="input_text" placeholder="여기에 원문을 붙여 넣으세요. (최대 약 8,000자)"
                    rows="10" maxlength="8000"></textarea>
          <div class="toolbar-inline">
            <button type="button" id="sm-run" class="btn">
              <span class="spinner" aria-hidden="true"></span>
              <span class="btn-label">요약하기</span>
            </button>
            <span id="sm-status" class="hint"></span>
            <span class="spacer"></span>
            <span id="usageInfo" class="hint"></span>
          </div>
          <p class="small hint">단축키: ⌘/Ctrl + Enter</p>
        </section>
      </form>

      <!-- 출력 -->
      <section class="card" style="margin-top:16px;">
        <h3>출력</h3>
        <textarea id="sm-out" class="outta" readonly placeholder="결과가 여기에 표시됩니다."></textarea>
        <div class="toolbar-inline" style="margin-top:8px;">
          <button id="copy-btn" class="btn secondary" type="button">복사</button>
          <span id="copy-hint" class="hint" style="display:none">복사됨</span>
          <span class="spacer"></span>
          <span class="small hint">※ 결과가 항상 완벽하진 않을 수 있습니다.</span>
        </div>
      </section>
    </div>
{% endblock %}

{% block scripts %}
  <script src="{{ url_for('static', filename='js/mainpage.js') }}" defer></script>
  <script>
  // 공통 JSON POST
  async function postJSON(url, body){
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json; charset=utf-8" },
      credentials: "include",
      body: JSON.stringify(body)
    });
    let data;
    try { data = await r.json(); } catch { data = null; }
    if (!r.ok) {
      const msg = (data && (data.error || data.message)) || ("HTTP " + r.status);
      throw new Error(msg);
    }
    return data || {};
  }

  async function runSummarize(){
    const status = document.getElementById("sm-status");
    const input  = document.getElementById("sm-text");
    const out    = document.getElementById("sm-out");
    const btn    = document.getElementById("sm-run");
    const text   = (input.value || "").trim();

    if(!text){
      out.value = "";
      status.textContent = "입력이 비어 있습니다.";
      return;
    }

    btn.disabled = true;
    status.textContent = "생성 중…";
    out.value = "";

    try{
      // 서버가 확실히 받도록 input_text로 보냄 (provider는 필요한 경우 지정)
      const res = await postJSON("/api/summarize", { input_text: text });
      const output = (res.output_text || res.output || (res.outputs && res.outputs[0]) || "").trim();

      if (output) {
        out.value = output;
        status.textContent = "완료";
      } else {
        // 모델이 빈 응답을 준 경우 사용자에게 안내
        out.value = "";
        status.textContent = "모델 응답이 비었습니다. 잠시 후 다시 시도하거나 문장을 더 짧게 입력해 보세요.";
      }

      // 요약 스코프로 사용량 갱신
      fetchUsage();
    }catch(e){
      out.value = "";
      status.textContent = "에러: " + (e.message || "요청 실패");
    }finally{
      btn.disabled = false;
      setTimeout(()=> status.textContent = "", 1500);
    }
  }

  document.getElementById("sm-form").addEventListener("submit", (e)=>{
    e.preventDefault();
    runSummarize();
  });

  document.getElementById("sm-run").addEventListener("click", runSummarize);

  // 단축키: Cmd/Ctrl + Enter (입력창에 포커스 있을 때만)
  document.addEventListener("keydown", (e)=>{
    if((e.metaKey || e.ctrlKey) && e.key === "Enter" && document.activeElement?.id === "sm-text"){
      e.preventDefault();
      runSummarize();
    }
  });

  // 복사
  document.getElementById("copy-btn").addEventListener("click", async ()=>{
    const out  = document.getElementById("sm-out");
    const hint = document.getElementById("copy-hint");
    try{
      await navigator.clipboard.writeText(out.value || "");
      hint.style.display = "inline";
      setTimeout(()=> hint.style.display = "none", 1200);
    }catch{}
  });

  // 요약 스코프 사용량 표기
  async function fetchUsage(){
    const el = document.getElementById("usageInfo");
    try{
      const r = await fetch("/api/usage?scope=summarize", { credentials:"include", cache:"no-store" });
      const j = await r.json();
      if(j && typeof j.used !== "undefined"){
        el.textContent = `요약 사용량 ${j.used} / ${j.limit} (${j.tier})`;
      }else{
        el.textContent = "";
      }
    }catch{
      el.textContent = "";
    }
  }
  fetchUsage();
</script>
{% endblock %}
